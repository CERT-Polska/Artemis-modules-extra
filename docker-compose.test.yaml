services:
  postgres-test:
    image: postgres
    restart: always
    shm_size: 256mb
    environment:
      POSTGRES_DB: artemis
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

  test-sqlmap:
    build:
      context: .
      dockerfile: karton_sqlmap/Dockerfile
    command: python -m unittest discover
    env_file: env.test

  test-moodle-scanner:
    build:
      context: .
      dockerfile: karton_moodle_scanner/Dockerfile
    command: python -m unittest discover
    env_file: env.test
    depends_on:
      - test-service-moodle
      - test-service-moodle-db

  test-ssl_checks:
    build:
      context: .
      dockerfile: karton_ssl_checks/Dockerfile
    command: python -m unittest discover
    env_file: env.test

  test-redis:
    image: redis:7.0.5

  test-service-with-sql-injection-mysql:
    build: test/images/php-mysql
    volumes:
      - ./test/data/sql_injection_mysql/:/var/www/html/

  test-service-with-sql-injection-mysql-db:
    image: mysql:5.6
    environment:
      MYSQL_ROOT_PASSWORD: root

  test-service-with-sql-injection-mysql-clean-urls:
    build: test/images/php-mysql
    volumes:
      - ./test/data/sql_injection_mysql_clean_urls/:/var/www/html/

  test-service-with-sql-injection-mysql-clean-urls-db:
    image: mysql:5.6
    environment:
      MYSQL_ROOT_PASSWORD: root

  test-service-with-sql-injection-postgres:
    build: test/images/php-postgres
    volumes:
      - ./test/data/sql_injection_postgres/:/var/www/html/

  test-service-with-sql-injection-postgres-db:
    image: postgres:14.1-alpine
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=root

  test-service-moodle:
    image: bitnami/moodle:4.2
    ports:
      - "8080:8080"
      - "8443:8443"
    environment:
      - MOODLE_DATABASE_HOST=test-service-moodle-db
      - MOODLE_DATABASE_PORT_NUMBER=3306
      - MOODLE_DATABASE_USER=bn_moodle
      - MOODLE_DATABASE_NAME=bitnami_moodle
      - MOODLE_DATABASE_PASSWORD=bitnami123
      - MOODLE_USERNAME=admin
      - MOODLE_PASSWORD=Admin123!
    depends_on:
      - test-service-moodle-db

  test-service-moodle-db:
    image: mariadb:10.6
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_USER=bn_moodle
      - MYSQL_PASSWORD=bitnami123
      - MYSQL_DATABASE=bitnami_moodle

  test-service-moodle-3-11:
    image: bitnami/moodle:3.11.4
    ports:
      - "8081:8080"
      - "8444:8443"
    environment:
      - MOODLE_DATABASE_HOST=test-service-moodle-3-11-db
      - MOODLE_DATABASE_PORT_NUMBER=3306
      - MOODLE_DATABASE_USER=bn_moodle
      - MOODLE_DATABASE_NAME=bitnami_moodle
      - MOODLE_DATABASE_PASSWORD=bitnami123
      - MOODLE_USERNAME=admin
      - MOODLE_PASSWORD=Admin123!
    depends_on:
      - test-service-moodle-3-11-db

  test-service-moodle-3-11-db:
    image: mariadb:10.6
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_USER=bn_moodle
      - MYSQL_PASSWORD=bitnami123
      - MYSQL_DATABASE=bitnami_moodle
